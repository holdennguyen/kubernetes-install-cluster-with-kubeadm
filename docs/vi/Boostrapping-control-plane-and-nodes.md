# Khởi tạo control plane và nodes
<p align="left">
<img src="https://kubernetes.io/images/favicon.png" width="50">
</p>

## Khởi tạo control plane

`control plane` là nơi chạy các `component` bao gồm `etcd` (cơ sở dữ liệu của `cluster`) và `API Server` (nơi các câu lệnh `kubectl` giao tiếp).

Để tiến hành khởi tạo, chạy câu lệnh sau ở máy ảo mà chúng ta đặt tên là `kubemaster`:

    sudo kubeadm init --apiserver-advertise-address=192.168.56.2 --pod-network-cidr=10.244.0.0/16
 
* `--apiserver-advertise-address=192.168.56.2`: Địa chỉ IP mà máy chủ API sẽ lắng nghe các câu lệnh. Trong hướng dẫn này sẽ là địa chỉa IP của máy ảo `kubemaster`.
* `--pod-network-cidr=10.244.0.0/16`: `control plane` sẽ tự động phân bổ địa chỉ IP trong `CIDR` chỉ định cho các `pod` trên mọi `node` trong cụm `cluster`. **Bạn sẽ cần phải chọn `CIDR` sao cho không trùng với bất kỳ dải mạng hiện có để tránh xung đột địa chỉ IP**.

`kubeadm init` đầu tiên sẽ chạy một loại các bước kiểm tra để đảm bảo máy đã sẵn sàng chạy `Kubernetes`. Những bước kiểm tra này sẽ đưa ra các cảnh báo và thoát lệnh khi có lỗi. Kế tiếp `kubeadm init` tải xuống và cài đặt các thành phần của `control plane`. Việc này có thể sẽ mất vài phút, sau khi kết thúc bạn sẽ thấy thông báo:

    Your Kubernetes control-plane has initialized successfully!

    To start using your cluster, you need to run the following as a regular user:

    mkdir -p $HOME/.kube
    sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
    sudo chown $(id -u):$(id -g) $HOME/.kube/config

    You should now deploy a Pod network to the cluster.
    Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
    /docs/concepts/cluster-administration/addons/

    You can now join any number of machines by running the following on each node
    as root:

    kubeadm join <control-plane-host>:<control-plane-port> --token <token> --discovery-token-ca-cert-hash sha256:<hash>

**Lưu lại câu lệnh `kubeadm join...` khi init thành công để thêm các node vào `cluster`**.

Để `kubectl` có thể dùng với `non-root user`, chạy những lệnh sau, chúng cũng được nhắc trong output khi `kubeadm init` thành công:

    mkdir -p $HOME/.kube
    sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
    sudo chown $(id -u):$(id -g) $HOME/.kube/config

Mặt khác, nếu bạn là `root user`, có thể dùng lệnh sau:

    export KUBECONFIG=/etc/kubernetes/admin.conf

>Cảnh báo: `Kubeadm` cấp certificate trong `admin.conf` để có `Subject: O = system:masters`, `CN = kubernetes-admin`. 
`system:masters` là một nhóm người dùng siêu cấp, bỏ qua lớp ủy quyền (như [RBAC](https://docs.oracle.com/cd/E19253-01/816-4557/rbac-1/)). Tuyệt đối không chia sẻ tệp `admin.conf` với bất kỳ ai, thay vào đó hãy cấp cho người dùng các quyền tùy chỉnh bằng cách tạo cho họ một tệp `kubeconfig` với lệnh `kubeadm kubeconfig`. Để biết thêm chi tiết hãy đọc [Generating kubeconfig files for additional users](https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/#kubeconfig-additional-users).

## Thêm các node vào cluster

Chạy câu lệnh trong phần output của `kubeadm init` trên tất cả các `worker node` - máy ảo:`kubenode01`, `kubenode02` với sudo permission:

    sudo kubeadm join --token <token> <control-plane-host>:<control-plane-port> --discovery-token-ca-cert-hash sha256:<hash>

**Nếu bạn không lưu lại lệnh `kubeadm join`, quay lại máy control-plane: `kubemaster`.**

**Lấy `<token>` bằng lệnh**

    kubeadm token list

Output sẽ tương tự như sau:

    TOKEN                    TTL  EXPIRES              USAGES           DESCRIPTION            EXTRA GROUPS
    8ewj1p.9r9hcjoqgajrj4gi  23h  2018-06-12T02:51:28Z authentication,  The default bootstrap  system:
                                                       signing          token generated by     bootstrappers:
                                                                        'kubeadm init'.        kubeadm:
                                                                                               default-node-token

Mặc định, `<tokens>` sẽ hết hạn sau `24 giờ`. Nếu bạn thêm `worker node` khi `<token>` đã hết hạn, bạn có thể tạo `<token>` mới bằng cách chạy lệnh sau trên `control-plane node`:

    kubeadm token create

Output sẽ cho `<token>` mới tương tự như sau:

    5didvk.d09sbcov8ph2amjw

**Lấy `<hash>` bằng lệnh**

    openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | \
    openssl dgst -sha256 -hex | sed 's/^.* //'

Output sẽ tương tự:

    8cb2de97839780a412b93877f8507ad6c94f73add17d5d7058e91741c9d5ec78

**Lấy `<control-plane-host>:<control-plane-port>` bằng lệnh**

    cat /$HOME/.kube/config | grep server

Sẽ được output tương tự:

    server: https://192.168.56.2:6443

**`<control-plane-host>:<control-plane-port>`** sẽ là **`192.168.56.2:6443`**

**Thêm `worker node` vào `Kubernetes cluster` thành công**

Bạn sẽ nhận được thông báo thành công như sau trên các máy `worker node`:

    [preflight] Running pre-flight checks

    ... (log output of join workflow) ...

    Node join complete:
    * Certificate signing request sent to control-plane and response
    received.
    * Kubelet informed of new secure connection details.

    Run 'kubectl get nodes' on control-plane to see this machine join.

Sau vài giây, bạn sẽ thấy thông tin `node` này trong phần `output` của lệnh `kubectl get nodes` khi chạy trên `control plane node`.

## Kiểm tra các component của Kubernetes cluster

![Components of kubernetes](../images/components-of-kubernetes.svg)

Ở control-plane `kubemaster` và worker nodes `kubenode01`, `kubenode02` chạy lệnh:

    sudo netstat -lntp

Tất cả các components với LISTEN ports tương ứng sẽ được hiển thị như dưới đây:

**kubemaster** 

    Active Internet connections (only servers)
    Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
    tcp        0      0 127.0.0.1:10248         0.0.0.0:*               LISTEN      8013/kubelet
    tcp        0      0 127.0.0.1:10249         0.0.0.0:*               LISTEN      8182/kube-proxy
    tcp        0      0 192.168.56.2:2379       0.0.0.0:*               LISTEN      7811/etcd
    tcp        0      0 127.0.0.1:2379          0.0.0.0:*               LISTEN      7811/etcd
    tcp        0      0 192.168.56.2:2380       0.0.0.0:*               LISTEN      7811/etcd
    tcp        0      0 127.0.0.1:2381          0.0.0.0:*               LISTEN      7811/etcd
    tcp        0      0 127.0.0.1:10257         0.0.0.0:*               LISTEN      7791/kube-controlle
    tcp        0      0 127.0.0.1:10259         0.0.0.0:*               LISTEN      7907/kube-scheduler
    tcp        0      0 127.0.0.1:34677         0.0.0.0:*               LISTEN      2826/containerd
    tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      817/systemd-resolve
    tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1380/sshd
    tcp6       0      0 :::10250                :::*                    LISTEN      8013/kubelet
    tcp6       0      0 :::6443                 :::*                    LISTEN      7884/kube-apiserver
    tcp6       0      0 :::10256                :::*                    LISTEN      8182/kube-proxy
    tcp6       0      0 :::22                   :::*                    LISTEN      1380/sshd

>`kube-apiserver` hiển thị chỉ LISTEN tới `IPv6 :::6443` nhưng thực chất `API server` đang lắng nghe qua địa chỉ `IPv6` cho phép truy cập qua địa chỉ `IPv4`, còn gọi là `IPv4-mapped IPv6 address`. Đây là lý do tại sao có thể chạy lệnh `kubeadm join` trên `worker nodes` thành công với `--apiserver-advertise-address` tới địa chỉ `IPv4`.
Ví dụ, địa chỉ IPv4 `192.168.5.2` có thể biểu diễn bằng địa chỉ IPv6 `::ffff:192.168.5.2`.

**kubenode***

    Active Internet connections (only servers)
    Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
    tcp        0      0 127.0.0.1:10248         0.0.0.0:*               LISTEN      8987/kubelet        
    tcp        0      0 127.0.0.1:10249         0.0.0.0:*               LISTEN      9208/kube-proxy     
    tcp        0      0 127.0.0.1:39989         0.0.0.0:*               LISTEN      2785/containerd     
    tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      782/systemd-resolve 
    tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1431/sshd
    tcp6       0      0 :::10250                :::*                    LISTEN      8987/kubelet        
    tcp6       0      0 :::10256                :::*                    LISTEN      9208/kube-proxy     
    tcp6       0      0 :::22                   :::*                    LISTEN      1431/sshd

## Cài đặt Pod network add-on

Chạy lệnh `kubectl get nodes` trên `control plane` để kiểm tra các `node` đã thêm vào `cluster`

    NAME           STATUS     ROLES           AGE    VERSION
    kubemaster     NotReady   control-plane   3h1m   v1.26.2
    kubenode01     NotReady   <none>          3h     v1.26.2
    kubenode02     NotReady   <none>          179m   v1.26.2

Có thể thấy, các máy ảo `kubemaster`, `kubenode01`, `kubenode02` đã được thêm vào `Kubernetes cluster` nhưng đang có `STATUS` là `NotReady`. 

Chạy lệnh `kubectl get pods -A` trên `control plane` để xem tất cả `pod` trong `kube-system namespace`

    NAMESPACE     NAME                                   READY   STATUS    RESTARTS   AGE
    kube-system   coredns-787d4945fb-5cwlq               0/1     Pending   0          3h8m
    kube-system   coredns-787d4945fb-q2s4p               0/1     Pending   0          3h8m
    kube-system   etcd-controlplane                      1/1     Running   0          3h8m
    kube-system   kube-apiserver-controlplane            1/1     Running   0          3h8m
    kube-system   kube-controller-manager-controlplane   1/1     Running   0          3h8m
    kube-system   kube-proxy-7twwr                       1/1     Running   0          3h7m
    kube-system   kube-proxy-8mxt7                       1/1     Running   0          3h8m
    kube-system   kube-proxy-v9rc6                       1/1     Running   0          3h8m
    kube-system   kube-scheduler-controlplane            1/1     Running   0          3h9m

Bạn phải triển khai `Container Network Interface (CNI)` hỗ trợ `Pod network add-on` để các `Pod` có thể giao tiếp với nhau. `Cluster DNS (CoreDNS)` sẽ không được khởi động cho đến khi hoàn thất thiết lập `pod network`.

`Pod network add-ons` là `Kubernetes-specific CNI plugins` cung cấp **kết nối mạng giữa các pod** trong một `Kubernetes cluster`. Nó tạo một `mạng overlay ảo` phủ toàn bộ `cluster` và gắn cho mỗi `pod` một địa chỉ IP riêng.

Trong khi `CNI plugins` có thể được sử dụng với mọi `container runtime`, `pod network add-ons` dành riêng cho `Kubernetes` và cung cấp chức năng mạng cần thiết cho `mô hình mạng Kubernetes`. Một số ví dụ về `pod network add-ons` có kể đến `Calico`, `Flannel`, and `Weave Net`. (Xem thêm các `pod network add-ons` khác tại [đây](https://kubernetes.io/docs/concepts/cluster-administration/addons/#networking-and-network-policy))

Trong hướng dẫn này, chúng ta sẽ sử dụng [Weave Net](https://www.weave.works/docs/net/latest/kubernetes/kube-addon/) add-ons. Nó dễ dàng cài đặt, sử dụng và phù hợp với việc triển khai ở quy mô nhỏ.

Để cài đặt nó cho `Kubernetes cluster`, chạy lệnh dưới đây trên control plane `kubemaster`:

    kubectl apply -f https://github.com/weaveworks/weave/releases/download/v2.8.1/weave-daemonset-k8s.yaml

Output sẽ như sau

    serviceaccount/weave-net created
    clusterrole.rbac.authorization.k8s.io/weave-net created
    clusterrolebinding.rbac.authorization.k8s.io/weave-net created
    role.rbac.authorization.k8s.io/weave-net created
    rolebinding.rbac.authorization.k8s.io/weave-net created
    daemonset.apps/weave-net created

Cần đảm bảo rằng `dải mạng của Pod` không bị trùng lặp với mạng trên các máy trong `cluster`. Nếu bạn khai báo `--pod-network-cidr` khi chạy `kubeadm init`, phải thêm tham số `IPALLOC_RANGE` vào tệp YAML của `Weave network plugin`. Chạy lệnh sau trên control plane `kubemaster`:

    kubectl edit ds weave-net -n kube-system

Lệnh này sẽ cho phép bạn chỉnh sửa tệp YAML của `weave-net daemon set`. Tìm đến phần `spec` của `container` có tham số `name: weave` để thêm biến môi trường `IPALLOC_RANGE` và truyền tham số `--pod-network-cidr` khi chạy `kubeadm init`. (Tệp được mở trong trình chỉnh sửa `vi`)

    spec:
    ...
        template:
        ...
            spec:
            ...
                containers:
                ...
                    env:
                    - name: IPALLOC_RANGE
                      value: 10.244.0.0/16
                      ...
                    name: weave

Lưu tệp và đợi một vài phút để `weave-net daemon set` khởi động lại các `pod`.

## Thiết lập thành công 

Chạy lại lệnh `kubectl get pods -A` trên control plane để kiểm tra, bạn sẽ thấy 3 pods của `weave-net daemon set` và `coredns pods` hiển thị đang chạy. (STATUS: Running)

    NAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE
    kube-system   coredns-787d4945fb-48tbh             1/1     Running   0          6m57s
    kube-system   coredns-787d4945fb-nrsp7             1/1     Running   0          6m57s
    kube-system   etcd-kubemaster                      1/1     Running   0          7m10s
    kube-system   kube-apiserver-kubemaster            1/1     Running   0          7m12s
    kube-system   kube-controller-manager-kubemaster   1/1     Running   0          7m10s
    kube-system   kube-proxy-8sxss                     1/1     Running   0          4m19s
    kube-system   kube-proxy-j7z6x                     1/1     Running   0          6m58s
    kube-system   kube-proxy-nj8j2                     1/1     Running   0          4m14s
    kube-system   kube-scheduler-kubemaster            1/1     Running   0          7m10s
    kube-system   weave-net-7mldz                      2/2     Running   0          2m
    kube-system   weave-net-dk5dl                      2/2     Running   0          70s
    kube-system   weave-net-znhnm                      2/2     Running   0          2m

Chạy `kubectl get nodes` để kiểm tra trạng thái các `node` trong `cluster`, chúng sẽ đều ở trạng thái sẵn sàng. (STATUS: Ready)

    NAME         STATUS   ROLES           AGE     VERSION
    kubemaster   Ready    control-plane   9m54s   v1.26.2
    kubenode01   Ready    <none>          6m59s   v1.26.2
    kubenode02   Ready    <none>          6m54s   v1.26.2

>Nếu bạn thắc mắc tại sao `ROLES` của các `worker node` hiển thị `<none>`, điều đó có nghĩa là các `node` này đang không chạy các `control plane component` hay `Kubernetes services` chỉ định `role`. Thông thường `worker nodes` sẽ không chạy các `control plane component`, vì thế điều này hoàn toàn bình thường trong một `Kubernetes cluster`.

`Networking` là một phần trung tâm của `Kubernetes`, xem thêm [Kubernetes networking model](https://kubernetes.io/docs/concepts/cluster-administration/networking/#how-to-implement-the-kubernetes-networking-model) để biết thêm thông tin.

Nếu muốn tùy chỉnh `cluster` với kubeadm, bạn có thể đọc [Create cluster kubeadm](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/).

▶️ [Dọn dẹp môi trường](Clean-up-environment.md/#clean-up-environment)
